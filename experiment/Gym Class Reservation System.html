<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gym Class Reservation System </title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
      color: #111827;
    }

    header {
      background: #111827;
      color: #f9fafb;
      padding: 14px 24px;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 24px 40px;
    }

    .user-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .user-bar input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }

    .user-bar label {
      font-size: 0.9rem;
      color: #4b5563;
    }

    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
    }

    button.primary {
      background: #2563eb;
      color: #f9fafb;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.small {
      padding: 4px 6px;
      font-size: 0.75rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .role-label {
      margin-left: auto;
      font-size: 0.85rem;
      color: #4b5563;
    }

    .message {
      margin: 8px 0 12px;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
      display: none;
    }

    .message.info {
      display: block;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
    }

    .message.success {
      display: block;
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      color: #15803d;
    }

    .message.error {
      display: block;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      padding: 10px 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.12);
      font-size: 0.85rem;
    }

    .controls-group {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .controls select,
    .controls input[type="text"] {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.6fr 1.4fr;
      gap: 16px;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .role-label {
        margin-left: 0;
        width: 100%;
      }
    }

    .panel {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px 14px 14px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      max-height: 70vh;
    }

    .panel h2 {
      margin: 0 0 4px;
      font-size: 1.05rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-subtitle {
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .panel-body {
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .class-card,
    .reservation-card {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .class-title {
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-available {
      background: #dcfce7;
      color: #166534;
    }

    .badge-full {
      background: #fee2e2;
      color: #b91c1c;
    }

    .badge-past {
      background: #e5e7eb;
      color: #374151;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.75rem;
      color: #4b5563;
    }

    .meta-label {
      font-weight: 500;
      color: #374151;
    }

    .card-footer {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    .empty-state {
      font-size: 0.8rem;
      color: #6b7280;
      font-style: italic;
      padding: 4px;
    }

    /* Admin panel */
    #adminPanel {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 8px;
      background: #111827;
      color: #e5e7eb;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.28);
      display: none; /* Hidden by default (buggy logic may show it incorrectly) */
    }

    #adminPanel h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    .admin-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #4b5563;
    }

    .admin-form {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px 8px;
      font-size: 0.78rem;
    }

    .admin-form label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .admin-form input,
    .admin-form select {
      padding: 4px 5px;
      border-radius: 4px;
      border: 1px solid #6b7280;
      font-size: 0.78rem;
      background: #020617;
      color: #e5e7eb;
    }

    .admin-actions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
    }

    .admin-actions button {
      font-size: 0.75rem;
    }

    .admin-classes {
      margin-top: 8px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.76rem;
    }

    .admin-class-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #374151;
      padding: 4px 0;
      gap: 6px;
    }

    .admin-class-row span {
      max-width: 55%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .admin-class-row .row-actions {
      display: flex;
      gap: 4px;
    }
  </style>
</head>
<body>
<header>
  <h1>Gym Class Reservation System </h1>
</header>

<div class="app">
  <!-- User + Admin login bar -->
  <div class="user-bar">
    <label for="userIdInput">User ID:</label>
    <input id="userIdInput" type="text" placeholder="Enter user ID" />

    <label for="adminKeyInput">Admin Key:</label>
    <input id="adminKeyInput" type="password" placeholder="Admin password" />

    <button class="primary" id="setUserBtn">Set User / Role</button>

    <div class="role-label" id="roleLabel">
      Current: <strong>Guest</strong> (no reservations)
    </div>
  </div>

  <div id="message" class="message info">
    Enter a User ID to start. Use filters and sorting to explore classes.
  </div>

  <!-- Sorting & Filtering Controls -->
  <div class="controls">
    <div class="controls-group">
      <span><strong>Sort by:</strong></span>
      <select id="sortField">
        <option value="datetime">Date/Time</option>
        <option value="title">Title</option>
      </select>
      <select id="sortDirection">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>
    </div>

    <div class="controls-group">
      <span><strong>Filter type:</strong></span>
      <select id="filterType">
        <option value="all">All</option>
        <option value="Strength">Strength</option>
        <option value="Cardio">Cardio</option>
        <option value="Mind &amp; Body">Mind &amp; Body</option>
        <option value="Mobility">Mobility</option>
      </select>
    </div>

    <div class="controls-group">
      <span><strong>Filter instructor:</strong></span>
      <select id="filterInstructor">
        <option value="all">All</option>
        <option value="Alex Carter">Alex Carter</option>
        <option value="Jamie Lee">Jamie Lee</option>
        <option value="Priya Patel">Priya Patel</option>
        <option value="Chris Wong">Chris Wong</option>
      </select>
    </div>

    <div class="controls-group">
      <span><strong>Search:</strong></span>
      <input id="searchInput" type="text" placeholder="Title key word" />
    </div>
  </div>

  <div class="layout">
    <!-- Available classes -->
    <section class="panel">
      <h2>Available Classes</h2>
      <div class="panel-subtitle">
        Browse and reserve classes. Sorting and filters should coordinate (intended).
      </div>
      <div id="classesList" class="panel-body"></div>
    </section>

    <!-- My Reservations -->
    <section class="panel">
      <h2>My Reservations</h2>
      <div class="panel-subtitle">
        Reservations belong to the currently active User ID.
      </div>
      <div id="reservationsList" class="panel-body"></div>
    </section>
  </div>

  <!-- Admin Panel (buggy permission logic deliberately implemented) -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <div class="panel-subtitle">
      Manage class schedule, edit details, and reorder classes.
    </div>

    <div class="admin-section">
      <strong>Class Editor</strong>
      <div class="admin-form">
        <label>
          Title
          <input type="text" id="adminTitleInput" />
        </label>
        <label>
          Type
          <select id="adminTypeInput">
            <option value="Strength">Strength</option>
            <option value="Cardio">Cardio</option>
            <option value="Mind &amp; Body">Mind &amp; Body</option>
            <option value="Mobility">Mobility</option>
          </select>
        </label>
        <label>
          Instructor
          <input type="text" id="adminInstructorInput" />
        </label>
        <label>
          Date/Time
          <input type="datetime-local" id="adminDateTimeInput" />
        </label>
        <label>
          Capacity
          <input type="number" id="adminCapacityInput" min="1" />
        </label>
        <label>
          Remaining
          <input type="number" id="adminRemainingInput" min="0" />
        </label>
      </div>
      <div class="admin-actions">
        <button class="secondary small" id="adminClearBtn">Clear</button>
        <button class="primary small" id="adminCreateBtn">Create Class</button>
        <button class="primary small" id="adminUpdateBtn">Update Class</button>
        <button class="secondary small" id="adminDeleteBtn">Delete Class</button>
      </div>
    </div>

    <div class="admin-section">
      <strong>Class List & Manual Order</strong>
      <div class="admin-classes" id="adminClassList"></div>
    </div>
  </div>
</div>

<script>
  // ========================================
  // Data Model
  // ========================================

  /**
   * Class model:
   * { id, title, type, instructor, datetime, capacity, remaining }
   */
  let classes = [
    {
      id: 1,
      title: "Morning Strength",
      type: "Strength",
      instructor: "Alex Carter",
      datetime: "2025-01-10T08:00",
      capacity: 10,
      remaining: 3
    },
    {
      id: 2,
      title: "Lunch Express Cardio",
      type: "Cardio",
      instructor: "Jamie Lee",
      datetime: "2025-01-10T12:15",
      capacity: 8,
      remaining: 0
    },
    {
      id: 3,
      title: "Evening Yoga Flow",
      type: "Mind & Body",
      instructor: "Priya Patel",
      datetime: "2025-01-11T18:00",
      capacity: 12,
      remaining: 7
    },
    {
      id: 4,
      title: "Mobility Basics",
      type: "Mobility",
      instructor: "Chris Wong",
      datetime: "2024-12-01T07:30", // past
      capacity: 15,
      remaining: 5
    },
    {
      id: 5,
      title: "Strength Foundations",
      type: "Strength",
      instructor: "Alex Carter",
      datetime: "2025-01-11T18:00", // same time as yoga
      capacity: 6,
      remaining: 6
    }
  ];

  /**
   * Reservation model:
   * { id, userId, classId }
   */
  let reservations = [];

  let currentUserId = "";
  let isAdmin = false;
  let selectedAdminClassId = null;

  // Sorting & filtering state
  let sortField = "datetime";
  let sortDirection = "asc";
  let filterType = "all";
  let filterInstructor = "all";
  let searchTerm = "";

  // ========================================
  // Utility Functions
  // ========================================

  function escapeHtml(text) {
    return String(text || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatDateTime(iso) {
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleString(undefined, {
      year: "numeric",
      month: "short",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function getStatusBadge(cls) {
    const now = new Date();
    const start = new Date(cls.datetime);

    if (start < now) {
      return { label: "Past", cls: "badge-past" };
    }
    if (cls.remaining <= 0) {
      return { label: "Full", cls: "badge-full" };
    }
    return { label: "Available", cls: "badge-available" };
  }

  function showMessage(text, type = "info") {
    const el = document.getElementById("message");
    el.textContent = text;
    el.className = "message " + type;
    el.style.display = "block";
  }

  function updateRoleLabel() {
    const el = document.getElementById("roleLabel");
    if (!currentUserId) {
      el.innerHTML = 'Current: <strong>Guest</strong> (no reservations)';
      return;
    }
    const roleText = isAdmin ? "Admin" : "User";
    el.innerHTML =
      "Current: <strong>" +
      escapeHtml(currentUserId) +
      "</strong> (" +
      roleText +
      ")";
  }

  function generateReservationId() {
    return "res_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2);
  }

  function generateClassId() {
    // buggy: does not avoid collision with existing IDs if called quickly
    return Math.floor(Math.random() * 100000);
  }

  // ========================================
  // Role / Login Logic (with intentional permission bugs)
  // ========================================

  function updateRoleFromInputs() {
    const userInput = document.getElementById("userIdInput").value.trim();
    const adminKey = document.getElementById("adminKeyInput").value.trim();

    if (!userInput) {
      currentUserId = "";
      isAdmin = false;
      // Hide admin panel if no user at all
      document.getElementById("adminPanel").style.display = "none";
      updateRoleLabel();
      renderReservations();
      showMessage("Please enter a User ID to use the system.", "error");
      return;
    }

    currentUserId = userInput;

    // Intended: admin requires specific ID + password.
    // Implemented (partly correct):
    isAdmin = currentUserId === "admin" && adminKey === "admin123";

    // BUG: Admin panel visibility uses a looser condition:
    // Any userId containing "admin" (case-insensitive) will see the panel,
    // even if the password is wrong or they are not true admins.
    const idLower = currentUserId.toLowerCase();
    if (idLower.includes("admin")) {
      document.getElementById("adminPanel").style.display = "block";
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }

    updateRoleLabel();
    renderReservations();
    renderClasses();
    renderAdminClassList();
    showMessage(
      "User set to '" +
        currentUserId +
        "' with role: " +
        (isAdmin ? "Admin" : "User"),
      "success"
    );
  }

  // ========================================
  // Sorting & Filtering (with intentional logic bugs)
  // ========================================

  function applySortAndFilter(inputList) {
    let list = inputList.slice();

    // Filtering by type
    if (filterType !== "all") {
      list = list.filter((c) => c.type === filterType);
    }

    // BUG: Instructor filter is ignored entirely (required bug).
    // Intended behavior: filter also by instructor when filterInstructor != 'all'.
    // (We simply do nothing with filterInstructor here.)

    // Search filter
    if (searchTerm) {
      // BUG: search is case-sensitive (optional bug: not case-insensitive)
      list = list.filter((c) => c.title.indexOf(searchTerm) !== -1);
    }

    // Sorting
    if (filterType === "all" && !searchTerm) {
      // Only sort when no filter/search is set.
      // BUG: When filters/search are active, list is not sorted,
      // breaking the expectation that filtering and sorting work together.
      list.sort((a, b) => compareForSort(a, b));
    } else {
      // BUG: When filtered, we do not apply sorting, causing inconsistent results.
    }

    return list;
  }

  function compareForSort(a, b) {
    if (sortField === "datetime") {
      const da = new Date(a.datetime);
      const db = new Date(b.datetime);
      if (da < db) return sortDirection === "asc" ? -1 : 1;
      if (da > db) return sortDirection === "asc" ? 1 : -1;
      return 0;
    }
    if (sortField === "title") {
      const ta = a.title.toLowerCase();
      const tb = b.title.toLowerCase();
      if (ta < tb) return sortDirection === "asc" ? -1 : 1;
      if (ta > tb) return sortDirection === "asc" ? 1 : -1;
      return 0;
    }
    return 0;
  }

  // ========================================
  // Rendering
  // ========================================

  function renderClasses() {
    const container = document.getElementById("classesList");
    if (!classes.length) {
      container.innerHTML =
        '<div class="empty-state">No classes defined.</div>';
      return;
    }

    const visible = applySortAndFilter(classes);
    let html = "";

    visible.forEach((cls) => {
      const status = getStatusBadge(cls);
      const isCurrentUserSet = !!currentUserId;

      // Reserve button is enabled if user is set.
      // BUGS in reservation/business rules are implemented in reserveClass().
      const reserveDisabled = isCurrentUserSet ? "" : "disabled";

      // BUG: inline edit button does not check admin; it will be rendered for everyone,
      // but we try to hide it only by text (not robust).
      const editButtonHtml = `
        <button class="secondary small edit-class-btn" data-id="${cls.id}">
          Edit
        </button>
      `;

      html += `
        <div class="class-card">
          <div class="card-header">
            <div class="class-title">${escapeHtml(cls.title)}</div>
            <span class="badge ${status.cls}">${status.label}</span>
          </div>
          <div class="meta-row">
            <span><span class="meta-label">Type:</span> ${escapeHtml(cls.type)}</span>
            <span><span class="meta-label">Instructor:</span> ${escapeHtml(cls.instructor)}</span>
          </div>
          <div class="meta-row">
            <span><span class="meta-label">Time:</span> ${formatDateTime(cls.datetime)}</span>
          </div>
          <div class="meta-row">
            <span><span class="meta-label">Capacity:</span> ${cls.capacity}</span>
            <span><span class="meta-label">Remaining:</span> ${cls.remaining}</span>
          </div>
          <div class="card-footer">
            <button class="primary reserve-btn" data-id="${cls.id}" ${reserveDisabled}>
              Reserve
            </button>
            ${editButtonHtml}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  function renderReservations() {
    const container = document.getElementById("reservationsList");

    if (!currentUserId) {
      container.innerHTML =
        '<div class="empty-state">Set a User ID to see your reservations.</div>';
      return;
    }

    const myReservations = reservations.filter(
      (r) => r.userId === currentUserId
    );

    if (!myReservations.length) {
      container.innerHTML =
        '<div class="empty-state">No reservations yet for this user.</div>';
      return;
    }

    const now = new Date();
    let html = "";

    myReservations
      .slice()
      .sort((a, b) => {
        const ca = classes.find((c) => c.id === a.classId);
        const cb = classes.find((c) => c.id === b.classId);
        if (!ca || !cb) return 0;
        return new Date(ca.datetime) - new Date(cb.datetime);
      })
      .forEach((res) => {
        const cls = classes.find((c) => c.id === res.classId);
        if (!cls) return;

        const start = new Date(cls.datetime);
        let label = "Upcoming";
        if (start < now) {
          label = "Past";
        } else if (start - now <= 60 * 60 * 1000) {
          label = "Starting soon";
        }

        html += `
          <div class="reservation-card">
            <div class="card-header">
              <div class="class-title">${escapeHtml(cls.title)}</div>
              <span class="badge badge-available">${label}</span>
            </div>
            <div class="meta-row">
              <span><span class="meta-label">Time:</span> ${formatDateTime(
                cls.datetime
              )}</span>
            </div>
            <div class="meta-row">
              <span><span class="meta-label">Type:</span> ${escapeHtml(
                cls.type
              )}</span>
              <span><span class="meta-label">Instructor:</span> ${escapeHtml(
                cls.instructor
              )}</span>
            </div>
            <div class="card-footer">
              <button class="secondary cancel-res-btn" data-res-id="${res.id}">
                Cancel
              </button>
            </div>
          </div>
        `;
      });

    container.innerHTML = html;
  }

  function renderAdminClassList() {
    const container = document.getElementById("adminClassList");
    if (!classes.length) {
      container.innerHTML = "<div>No classes defined.</div>";
      return;
    }

    let html = "";
    classes.forEach((cls, index) => {
      html += `
        <div class="admin-class-row" data-id="${cls.id}">
          <span>#${index + 1} ${escapeHtml(cls.title)}</span>
          <div class="row-actions">
            <button class="small secondary admin-load-btn" data-id="${cls.id}">
              Load
            </button>
            <button class="small secondary admin-up-btn" data-id="${cls.id}">
              ↑
            </button>
            <button class="small secondary admin-down-btn" data-id="${cls.id}">
              ↓
            </button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // ========================================
  // Reservation Logic (with intentional bugs)
  // ========================================

  function reserveClass(classId) {
    if (!currentUserId) {
      showMessage("Please set a user before reserving.", "error");
      return;
    }

    const cls = classes.find((c) => c.id === classId);
    if (!cls) {
      showMessage("Selected class not found.", "error");
      return;
    }

    // Intended rules (NOT implemented here on purpose):
    // - Disallow reserving past classes
    // - Disallow reserving full classes
    // - Disallow double-booking at same time
    // - Disallow more than 3 future reservations

    // BUG 1: Overbooking allowed → capacity rule ignored
    // BUG 2: Past classes can still be reserved → no time check
    // BUG 3: Double booking allowed → no overlap check
    // BUG 4: Unlimited future reservations → no max-reservation check

    const reservation = {
      id: generateReservationId(),
      userId: currentUserId,
      classId: cls.id
    };
    reservations.push(reservation);

    // Decrement remaining even if 0 or negative (overbooking)
    cls.remaining = (cls.remaining || 0) - 1;

    renderReservations();
    renderClasses();
    showMessage("Reservation created successfully (demo).", "success");
  }

  function cancelReservation(resId) {
    const idx = reservations.findIndex((r) => r.id === resId);
    if (idx === -1) {
      showMessage("Reservation not found.", "error");
      return;
    }

    const res = reservations[idx];
    const cls = classes.find((c) => c.id === res.classId);

    // Intended rules (NOT enforced here):
    // - Disallow cancelling past reservations
    // - Disallow cancelling within 1 hour of start time
    //
    // BUG 5: Cancelling past classes allowed
    // BUG 6: Cancelling within 1 hour allowed

    if (cls) {
      cls.remaining = (cls.remaining || 0) + 1;
    }

    reservations.splice(idx, 1);

    // BUG 7: Slot count not refreshed in Available Classes after cancellation.
    // We only re-render reservations, not classes.
    renderReservations();

    showMessage("Reservation cancelled (demo).", "success");
  }

  // ========================================
  // Admin Logic (with intentional permission bugs)
  // ========================================

  function loadClassIntoAdminForm(classId) {
    const cls = classes.find((c) => c.id === classId);
    if (!cls) return;

    selectedAdminClassId = cls.id;
    document.getElementById("adminTitleInput").value = cls.title;
    document.getElementById("adminTypeInput").value = cls.type;
    document.getElementById("adminInstructorInput").value = cls.instructor;
    document.getElementById("adminDateTimeInput").value = cls.datetime;
    document.getElementById("adminCapacityInput").value = cls.capacity;
    document.getElementById("adminRemainingInput").value = cls.remaining;
  }

  function clearAdminForm() {
    selectedAdminClassId = null;
    document.getElementById("adminTitleInput").value = "";
    document.getElementById("adminTypeInput").value = "Strength";
    document.getElementById("adminInstructorInput").value = "";
    document.getElementById("adminDateTimeInput").value = "";
    document.getElementById("adminCapacityInput").value = "";
    document.getElementById("adminRemainingInput").value = "";
  }

  function createClassFromAdmin() {
    // BUG: Permission check missing here → non-admin can create classes
    const title = document.getElementById("adminTitleInput").value.trim();
    const type = document.getElementById("adminTypeInput").value;
    const instructor = document
      .getElementById("adminInstructorInput")
      .value.trim();
    const datetime = document.getElementById("adminDateTimeInput").value;
    const capacity = parseInt(
      document.getElementById("adminCapacityInput").value,
      10
    );
    const remaining = parseInt(
      document.getElementById("adminRemainingInput").value,
      10
    );

    if (!title || !instructor || !datetime || !capacity) {
      showMessage("Admin: title, instructor, datetime, capacity are required.", "error");
      return;
    }

    const newClass = {
      id: generateClassId(),
      title,
      type,
      instructor,
      datetime,
      capacity: isNaN(capacity) ? 0 : capacity,
      remaining: isNaN(remaining) ? capacity : remaining
    };

    classes.push(newClass);

    renderClasses();
    renderAdminClassList();
    // BUG: Reservations involving this class (none yet) would not propagate edits,
    // but that's acceptable here.
    showMessage("Admin: class created.", "success");
  }

  function updateClassFromAdmin() {
    // Partial permission check:
    if (!isAdmin) {
      // BUG: We show error, but other editing paths (inline edit, reorder) ignore this.
      showMessage("Only true admin may update class details.", "error");
      return;
    }

    if (selectedAdminClassId == null) {
      showMessage("Admin: select a class to update.", "error");
      return;
    }

    const cls = classes.find((c) => c.id === selectedAdminClassId);
    if (!cls) {
      showMessage("Admin: selected class not found.", "error");
      return;
    }

    const title = document.getElementById("adminTitleInput").value.trim();
    const type = document.getElementById("adminTypeInput").value;
    const instructor = document
      .getElementById("adminInstructorInput")
      .value.trim();
    const datetime = document.getElementById("adminDateTimeInput").value;
    const capacity = parseInt(
      document.getElementById("adminCapacityInput").value,
      10
    );
    const remaining = parseInt(
      document.getElementById("adminRemainingInput").value,
      10
    );

    // Update fields
    cls.title = title || cls.title;
    cls.type = type || cls.type;
    cls.instructor = instructor || cls.instructor;

    // BUG: Date/time update is ignored if empty, but we never validate format.
    if (datetime) {
      cls.datetime = datetime;
    }

    // BUG: capacity vs remaining can become inconsistent; no validation here.
    if (!isNaN(capacity)) {
      cls.capacity = capacity;
    }
    if (!isNaN(remaining)) {
      cls.remaining = remaining;
    }

    renderClasses();
    // BUG 8: Admin edit UI updates only partially:
    // We forget to re-render reservations after edits, so reservation cards
    // may show outdated title/time/instructor.
    renderAdminClassList();

    showMessage("Admin: class updated.", "success");
  }

  function deleteClassFromAdmin() {
    // BUG: Missing permission check → non-admin can delete.
    if (selectedAdminClassId == null) {
      showMessage("Admin: select a class to delete.", "error");
      return;
    }

    const idx = classes.findIndex((c) => c.id === selectedAdminClassId);
    if (idx === -1) {
      showMessage("Admin: class not found.", "error");
      return;
    }

    classes.splice(idx, 1);

    // BUG: related reservations are not removed, leading to orphan reservations.
    clearAdminForm();
    renderClasses();
    renderAdminClassList();
    showMessage("Admin: class deleted.", "success");
  }

  function moveClassUp(id) {
    // BUG: No permission check here → any user can reorder via admin panel.
    const idx = classes.findIndex((c) => c.id === id);
    if (idx > 0) {
      const tmp = classes[idx - 1];
      classes[idx - 1] = classes[idx];
      classes[idx] = tmp;
      renderClasses();
      // BUG 9: Some UI views show outdated state: reservations not re-rendered,
      // and admin list sometimes not re-rendered after reorder.
    }
    renderAdminClassList();
  }

  function moveClassDown(id) {
    const idx = classes.findIndex((c) => c.id === id);
    if (idx !== -1 && idx < classes.length - 1) {
      const tmp = classes[idx + 1];
      classes[idx + 1] = classes[idx];
      classes[idx] = tmp;
      renderClasses();
      renderAdminClassList();
    }
  }

  // Inline edit button from class card
  function handleInlineEditClick(classId) {
    // BUG: No permission check → any user can use inline edit to open admin form.
    loadClassIntoAdminForm(classId);
    // Also, make sure admin panel becomes visible once they click edit,
    // even if they are not true admin.
    document.getElementById("adminPanel").style.display = "block";
    showMessage("Inline edit: class loaded into admin form.", "info");
  }

  // ========================================
  // Event Wiring
  // ========================================

  document.addEventListener("DOMContentLoaded", () => {
    document
      .getElementById("setUserBtn")
      .addEventListener("click", updateRoleFromInputs);

    document
      .getElementById("userIdInput")
      .addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          updateRoleFromInputs();
        }
      });

    // Sorting & filtering events
    document.getElementById("sortField").addEventListener("change", (e) => {
      sortField = e.target.value;
      renderClasses();
    });

    // BUG 10: sortDirection UI handler forgets to update sortDirection variable
    // when changing from "desc" back to "asc" if current value is "asc".
    document
      .getElementById("sortDirection")
      .addEventListener("change", (e) => {
        const value = e.target.value;
        if (value === "desc") {
          sortDirection = "desc";
        }
        // If value is "asc", we do NOT update sortDirection back,
        // so sorting sometimes does not reflect the chosen direction.
        renderClasses();
      });

    document.getElementById("filterType").addEventListener("change", (e) => {
      filterType = e.target.value;
      renderClasses();
    });

    document
      .getElementById("filterInstructor")
      .addEventListener("change", (e) => {
        filterInstructor = e.target.value;
        // BUG: filterInstructor value is stored but never used in applySortAndFilter.
        renderClasses();
      });

    document.getElementById("searchInput").addEventListener("input", (e) => {
      searchTerm = e.target.value;
      renderClasses();
    });

    // Class list (reserve + inline edit)
    document.getElementById("classesList").addEventListener("click", (e) => {
      const reserveBtn = e.target.closest(".reserve-btn");
      if (reserveBtn) {
        const id = parseInt(reserveBtn.dataset.id, 10);
        if (!Number.isNaN(id)) {
          reserveClass(id);
        }
        return;
      }
      const editBtn = e.target.closest(".edit-class-btn");
      if (editBtn) {
        const id = parseInt(editBtn.dataset.id, 10);
        if (!Number.isNaN(id)) {
          handleInlineEditClick(id);
        }
      }
    });

    // Reservations list (cancel)
    document
      .getElementById("reservationsList")
      .addEventListener("click", (e) => {
        const cancelBtn = e.target.closest(".cancel-res-btn");
        if (cancelBtn) {
          const resId = cancelBtn.dataset.resId;
          if (resId) {
            cancelReservation(resId);
          }
        }
      });

    // Admin panel events
    document.getElementById("adminClassList").addEventListener("click", (e) => {
      const loadBtn = e.target.closest(".admin-load-btn");
      const upBtn = e.target.closest(".admin-up-btn");
      const downBtn = e.target.closest(".admin-down-btn");

      if (loadBtn) {
        const id = parseInt(loadBtn.dataset.id, 10);
        if (!Number.isNaN(id)) {
          loadClassIntoAdminForm(id);
        }
      } else if (upBtn) {
        const id = parseInt(upBtn.dataset.id, 10);
        if (!Number.isNaN(id)) {
          moveClassUp(id);
        }
      } else if (downBtn) {
        const id = parseInt(downBtn.dataset.id, 10);
        if (!Number.isNaN(id)) {
          moveClassDown(id);
        }
      }
    });

    document
      .getElementById("adminClearBtn")
      .addEventListener("click", clearAdminForm);
    document
      .getElementById("adminCreateBtn")
      .addEventListener("click", createClassFromAdmin);
    document
      .getElementById("adminUpdateBtn")
      .addEventListener("click", updateClassFromAdmin);
    document
      .getElementById("adminDeleteBtn")
      .addEventListener("click", deleteClassFromAdmin);

    // Initial render
    updateRoleLabel();
    renderClasses();
    renderReservations();
    renderAdminClassList();
  });
</script>
</body>
</html>
